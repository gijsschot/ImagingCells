\part{Results}
\chapter{Results}
\section{Imaging live cells}
For the study described in \textbf{Paper I} we used cells of two species of cyanobacteria as a sample: Cyanobium gracile and Synechococcus elongatus. Cyanobacteria are photosynthetic bacteria that can be found in almost any habitat on earth, ranging from hot volcanic areas to cold polar ice caps, and play an important role in the global carbon and nitrogen cycle. In a 25 day cycle an algal bloom of 1000 $km^2$ can sequester around 22,000 tonnes of atmospheric carbon into organic carbon before an infection by cyanophages caused the bloom to collapse.
 
Cyanobium gracile cells were selected for their small size and their robustness with respect to the injection procedure. Solitary C. gracile and S. elongatus cells have an oval-to-cylindrical shape, and vary in size between 0.25-0.4 $\mu$m in diameter and 0.4-4.0 $\mu$m in length [Komarek]. Cells divide symmetrically by binary fission. The two daughter cells separate from each other after reaching the size and shape of the mother cell [Komarek2]. We used non-synchronised cell cultures undergoing active growth providing cells in various stages of their cell cycle. 

The experiments described in \textbf{Paper I} were carried out at the atomic, molecular, and optical science (AMO) endstation at LCLS \cite{Bostedt2013}, at 512 eV (2.40 nm) and 1100 eV (1.13 nm) photon energy.  Figure \ref{fig:ExperimentalSetup} shows the arrangement of the experiment. The length of the photon bunch was about 70 fs. The pulse was focused to a spot of 3 $\mu m$ x 7 $\mu m$. The average photon density in the focus was about $1.1 x 10^{11}$ photons/pulse/$\mu m^2$ at 517 eV, and $8.6 x 10^{10}$ photons/pulse/$\mu m^2$ at 1,100 eV. Far-field diffraction patterns were recorded on a pair of pnCCD detectors \cite{Struder2010} in the CFEL-ASG Multi Purpose (CAMP) instrument \cite{Struder2010}. The detectors were place at 741 mm downstream from the interaction region of the beam and the sample. The detector read out rate matched the 120 Hz repetition rate of the LCLS. 

We collected diffraction patterns of C. gracile cells for 60 minutes at a hit ratio of 43\% and selected the 7,500 clear hits for further analysis, using the Cheetah software package \cite{Barty2014}. The linear sampling ratio of the particle was around 20-fold, which allowed direct phase recovery from the measured intensity patterns. Phase retrieval was not a trivial problem because strong hits saturated the detectors at low diffraction angles. As a compromise, we manually selected medium-strong hits, which contained either no, or only few saturated pixels, while still providing scattered signal to reasonably high resolution. Missing mode analysis revealed no unconstrained modes for all reconstructed cells presented in \textbf{Paper I}. 

Figure  shows the reconstructed exit wave-fronts (images) for six live C. gracile cells together with the corresponding diffraction patterns, and a synthetic Nomarski image. The reconstructions represent 2D projections of the electron density of the cells. The images show the expected morphologies of cells during division [Komarek,Komarek2]. The resolution of each  reconstruction is indicated by the size of the round white dot. Features smaller than the dot need to be interpreted with care.

Phases were retrieved using the Hawk software package. For each pattern 400 reconstructions were made, each starting from different random initial phases. These reconstructions consisted of 5000 iterations with the RAAR algorithm [Luke], using a Shrinkwrap algorithm[Marchesini] for support determination, and concluded with 100 iterations by the ER algorithm[Fienup, Gerchberg-Saxton]. The initial and final support size was selected manually. No additional constraints were used since we anticipated the effects of absorption in the thick cells to give effects similar to a phase object. 

Resolution for the reconstructions was estimated from the PRTF (See Figure \ref{fig:ExperimentalSetup}), using the 1/e cutoff. Before calculating a PRTF and averaging the images we removed outliers among the reconstructions by applying a threshold to the Fourier error. Clustering validates the results from using a threshold on the Fourier-Error and the real-space error(Figures 7 a-j). On average the main cluster contained about 370 out of 400 reconstructions (93\%), except for one case where only 96 reconstructions formed the biggest cluster (Figure 7j). This made us believe that the average image of the main cluster is the true reconstruction minimum. Th failed reconstructions did not find the true minimum.
The scatter plots of Figure 7 a-j show that the real-space error is more reliable than the Fourier-error for identifying failed reconstructions.

Detector saturation limited the achievable resolution.  In fact, the reconstructions shown in Figure \ref{fig:ExperimentalSetup} come from exposures that did not saturate the detectors. A number of much stronger exposures were also recorded, and in some of these exposures the diffraction signal extended to nanometer resolution. Figure \ref{fig:ExperimentalSetup} shows one such pattern for a live S. elongatus cell at 1,100 eV photon energy, 70 fs pulse length, about $10^11$ photons $\mu m^{-2}$ on the sample. Four pnCCD detectors were used to record this pattern (Figure \ref{fig:ExperimentalSetup}b). The configuration of the central back detector in Figure  is identical to the detector used in Figure . The front detector is the same type as the back detector but is placed at 220 mm from the interaction region. In this strong hit, a large part of the back detector was saturated, preventing reliable phasing. The signal however extended beyond 4 nm resolution on the front detectors (at sigma 3.7), which is the size of a small protein molecule. More than 58 million scattered photons were recorded on the back detectors, and 1.3 million on the front detectors. The size of the cell was derived from the autocorrelation. Figure 4c shows that in a log/log representation the drop-off of the signal is linear with spatial frequency in the range covered by our measurements, and the exponent of the signal decay is $-3.31\pm0.01$, matching simulations [Jakobson].

 

\section{Classification}

Sizing diffraction pattern
\\
Sizing Autocorrelation
\\
Identification multiple scatterers
\\	1) Multiple Particles
\\	2) Holographic Images
\\
Edge detection
\\
Particle shape detection
\\	1) Round particles
\\	2) Elongated Particles
\\
Success on wide variety of sizes and scattering strengths.
\\
Template-based Classification
\\

\section{Software}
Given the high data rates of XFELs it is impossible for humans to go through all data frames individually, and assistance of computers is needed.
RedFlamingo is a software framework designed to rapidly assess individual diffraction patterns by reducing their complexity to a small set of interpretable numbers. The power of RedFlamingo lies in its modularity: users have the option to select a combination of algorithms they want to use for data evaluation, and can port their own algorithms. This is important, as each sample and experiment will come with its own set of demands on data analysis. For example the number of scattered photons vary considerably from sample to sample. This will affect the way diffraction patterns can be evaluated. Furthermore, the detector type often changes from experimental station to experimental station, and each experiment has its own specific artefacts due to the experimental condition at the time of operation. Within this variation it is very important to be able to know whether or not you are imaging the particle of interest, at what rate, and if it is intact. For deeper data analysis one often needs to limit the amount of heterogeneity within the data to an even larger extend. This makes is very difficult to design algorithms that are useful for every data set. RedFlamingo will make it possible to combine algorithms from different experiments, each often designed to tackle a specific problem. 

As input RedFlamingo takes a set of diffraction patterns $D$, and a configuration file $C$. The configuration file sets which algorithms should be run, as well as the variables needed to run these algorithms. An example of an input file can be found in Figure \ref{fig:IN_OUT_FILE} Figure \ref{fig:WorkFlow_RF} shows the general pipeline of RedFlamingo, as well as the algorithms currently included into it.


RedFlamingo has been tested on several datasets. This chapter shows three cases that illustrate different demands on the data analysis. In the first example, RedFlamingo is used for pattern classification. The main discriminatory features were size, particle elongation, and number of particles in the beam. The second example shows that RedFlamingo can be used to size particles of a wide range of sizes.  

\subsection{Pattern Classification of heterogeneous RDV data set}
Rice Dwarf Virus (RDV) is the causal agent of rice dwarf disease. It can result in severe crop losses in rice and other gramineae plants in East Asian countries due to stunted growth and chlorotic specks. The structure of RDV has previously been solved to 3.5 $A$ resolution by X-ray crystallography \cite{Nakagawa2003} (PDB 1UF2). RDV is approximately 72 nm in diameter.

Most diffraction patterns in this data set are not affected by detector saturation, which makes it possible to estimate the size of the icosahedral-shaped particle by determining the location of the first minima (see chapter 7).
RDV was classified on the size and shape of the central speckle, and the size and shape of the central term in the autocorrelation. If the central speckle and the central term of the autocorrelation are circular to slightly elongated the particle was classified as a single particle.  

\begin{figure}[h]
\centering
\includegraphics[width=100mm]{Chapter_09_Results_RDV_classes.png}
\includegraphics[width=100mm]{Chapter_09_Results_RDV_size_distribution.png}\label{fig:Classes}
\caption{Classification of particles. Top: one example pattern from each class is shown. The gap between the two detector halves and the beam stop is masked out. Bottom: the size distribution of the 3608 diffraction patterns classified as single hits shows a peak at 63 nm.}
\end{figure}

There are

The second example 